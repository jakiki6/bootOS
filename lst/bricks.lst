     1                                  	;
     2                                  	; Bricks game in one boot sector
     3                                  	;
     4                                  	; by Oscar Toledo G.
     5                                  	;
     6                                  	; Creation date: Nov/02/2019.
     7                                  	;
     8                                  
     9                                  	cpu 8086
    10                                  
    11                                  	;
    12                                  	; Press Left Shift to start the game
    13                                  	; Press Left Ctrl to move the paddle to the left
    14                                  	; Press Left Alt to move the paddle to the right
    15                                  	;
    16                                  
    17                                      %ifdef com_file
    18                                          org 0x0100
    19                                      %else
    20                                          org 0x7c00
    21                                      %endif
    22                                  
    23                                  old_time:	equ 16	; Old time 
    24                                  ball_x:		equ 14	; X-coordinate of ball (8.8 fraction)
    25                                  ball_y:		equ 12	; Y-coordinate of ball (8.8 fraction)
    26                                  ball_xs:	equ 10	; X-speed of ball (8.8 fraction)
    27                                  ball_ys:	equ 8	; Y-speed of ball (8.8 fraction)
    28                                  beep:		equ 6	; Frame count to turn off sound
    29                                  bricks:		equ 4	; Remaining bricks
    30                                  balls:         equ 2	; Remaining balls
    31                                  score:         equ 0	; Current score
    32                                  
    33                                  	;
    34                                  	; Start of the game
    35                                  	;
    36                                  start:
    37 00000000 B80200                  	mov ax,0x0002		; Text mode 80x25x16 colors
    38 00000003 CD10                    	int 0x10		; Setup
    39 00000005 B800B8                  	mov ax,0xb800		; Address of video screen
    40 00000008 8ED8                    	mov ds,ax		; Setup DS
    41 0000000A 8EC0                    	mov es,ax		; Setup ES
    42 0000000C 83EC20                  	sub sp,32
    43 0000000F 31C0                    	xor ax,ax
    44 00000011 50                      	push ax			; Reset score
    45 00000012 B004                    	mov al,4		
    46 00000014 50                      	push ax			; Balls remaining
    47 00000015 89E5                    	mov bp,sp		; Setup stack frame for globals
    48                                  	;
    49                                  	; Start another level 
    50                                  	;
    51                                  another_level:
    52 00000017 C746041101              	mov word [bp+bricks],273	; 273 bricks on screen
    53 0000001C 31FF                    	xor di,di
    54 0000001E B8B101                  	mov ax,0x01b1		; Draw top border
    55 00000021 B95000                  	mov cx,80
    56 00000024 FC                      	cld
    57 00000025 F3AB                    	rep stosw
    58 00000027 B118                    	mov cl,24		; 24 rows
    59                                  .1:
    60 00000029 AB                      	stosw			; Draw left border
    61 0000002A B82000                  	mov ax,0x20		; No bricks on this row
    62 0000002D 51                      	push cx
    63 0000002E 80F917                  	cmp cl,23
    64 00000031 7309                    	jnb .2
    65 00000033 80E90F                  	sub cl,15
    66 00000036 7604                    	jbe .2
    67 00000038 B0DB                    	mov al,0xdb		; Bricks on this row
    68 0000003A 88CC                    	mov ah,cl
    69                                  .2:
    70 0000003C B127                    	mov cl,39		; 39 bricks per row
    71                                  .3:
    72 0000003E AB                      	stosw
    73 0000003F AB                      	stosw
    74 00000040 FEC4                    	inc ah			; Increase attribute color
    75 00000042 80FC08                  	cmp ah,0x08
    76 00000045 7502                    	jne .4
    77 00000047 B401                    	mov ah,0x01
    78                                  .4:
    79 00000049 E2F3                    	loop .3
    80 0000004B 59                      	pop cx
    81                                  
    82 0000004C B8B101                  	mov ax,0x01b1		; Draw right border
    83 0000004F AB                      	stosw
    84 00000050 E2D7                    	loop .1
    85                                  
    86                                  	;
    87                                  	; Start another ball
    88                                  	;
    89 00000052 BF4A0F                  	mov di,0x0f4a		; Position of paddle
    90                                  another_ball:
    91 00000055 C6460F28                	mov byte [bp+ball_x+1],0x28	; Center X
    92 00000059 C6460D14                	mov byte [bp+ball_y+1],0x14	; Center Y
    93 0000005D 31C0                    	xor ax,ax
    94 0000005F 89460A                  	mov [bp+ball_xs],ax	; Static on screen
    95 00000062 894608                  	mov [bp+ball_ys],ax
    96 00000065 C6460601                	mov byte [bp+beep],0x01
    97                                  
    98 00000069 BEFE0F                  	mov si,0x0ffe		; Don't erase ball yet
    99                                  game_loop:
   100 0000006C E81101                  	call wait_frame		; Wait 1/18.2 secs.
   101 0000006F CD27                    	int 0x27
   102 00000071 C7040000                	mov word [si],0x0000	; Erase ball
   103                                  	
   104 00000075 E84401                  	call update_score	; Update score
   105                                  	
   106 00000078 B402                    	mov ah,0x02		; Read modifier keys
   107 0000007A CD16                    	int 0x16
   108 0000007C A804                    	test al,0x04		; Left ctrl
   109 0000007E 7414                    	je .1
   110 00000080 C6450600                	mov byte [di+6],0	; Erase right side of paddle
   111 00000084 C6450800                	mov byte [di+8],0
   112 00000088 83EF04                  	sub di,byte 4		; Move paddle to left
   113 0000008B 81FF020F                	cmp di,0x0f02		; Limit
   114 0000008F 7703                    	ja .1
   115 00000091 BF020F                  	mov di,0x0f02
   116                                  .1:
   117 00000094 A808                    	test al,0x08		; Left alt
   118 00000096 740D                    	je .2
   119 00000098 31C0                    	xor ax,ax		; Erase left side of paddle
   120 0000009A AB                      	stosw
   121 0000009B AB                      	stosw			; DI increased automatically
   122 0000009C 81FF940F                	cmp di,0x0f94		; Limit
   123 000000A0 7203                    	jb .2
   124 000000A2 BF940F                  	mov di,0x0f94	
   125                                  .2:
   126 000000A5 A802                    	test al,0x02		; Left shift
   127 000000A7 7412                    	je .15
   128 000000A9 8B460A                  	mov ax,[bp+ball_xs]	; Ball moving?
   129 000000AC 034608                  	add ax,[bp+ball_ys]
   130 000000AF 750A                    	jne .15			; Yes, jump
   131                                  				; Setup movement of ball
   132 000000B1 C7460A40FF              	mov word [bp+ball_xs],0xff40
   133 000000B6 C7460880FF              	mov word [bp+ball_ys],0xff80
   134                                  .15:
   135 000000BB B8DF0A                  	mov ax,0x0adf		; Paddle graphic and color
   136 000000BE 57                      	push di
   137 000000BF AB                      	stosw			; Draw paddle
   138 000000C0 AB                      	stosw
   139 000000C1 AB                      	stosw
   140 000000C2 AB                      	stosw
   141 000000C3 AB                      	stosw
   142 000000C4 5F                      	pop di
   143                                  
   144 000000C5 8B5E0E                  	mov bx,[bp+ball_x]		; Draw ball
   145 000000C8 8B460C                  	mov ax,[bp+ball_y]
   146 000000CB E8E100                  	call locate_ball	; Locate on screen
   147 000000CE F6460C80                	test byte [bp+ball_y],0x80	; Y-coordinate half fraction?
   148 000000D2 B460                    	mov ah,0x60		; Interchange colors for smooth mov.
   149 000000D4 7402                    	je .12
   150 000000D6 B406                    	mov ah,0x06
   151 000000D8 B0DC                    .12:	mov al,0xdc		; Graphic
   152 000000DA 8907                    	mov [bx],ax		; Draw
   153 000000DC 53                      	push bx
   154 000000DD 5E                      	pop si
   155                                  
   156                                  .14:
   157 000000DE 8B5E0E                  	mov bx,[bp+ball_x]		; Ball position
   158 000000E1 8B460C                  	mov ax,[bp+ball_y]
   159 000000E4 035E0A                  	add bx,[bp+ball_xs]	; Add movement speed
   160 000000E7 034608                  	add ax,[bp+ball_ys]
   161 000000EA 50                      	push ax
   162 000000EB 53                      	push bx
   163 000000EC E8C000                  	call locate_ball	; Locate on screen
   164 000000EF 8A07                    	mov al,[bx]
   165 000000F1 3CB1                    	cmp al,0xb1		; Touching borders
   166 000000F3 751D                    	jne .3
   167 000000F5 B92F15                  	mov cx,5423		; 1193180 / 220
   168 000000F8 E89D00                  	call speaker		; Generate sound
   169 000000FB 5B                      	pop bx
   170 000000FC 58                      	pop ax
   171 000000FD 80FF4F                  	cmp bh,0x4f
   172 00000100 7404                    	je .8
   173 00000102 84FF                    	test bh,bh
   174 00000104 7503                    	jne .7
   175                                  .8:
   176 00000106 F75E0A                  	neg word [bp+ball_xs]	; Negate X-speed if it touches a side
   177                                  .7:	
   178 00000109 84E4                    	test ah,ah
   179 0000010B 7503                    	jnz .9
   180 0000010D F75E08                  	neg word [bp+ball_ys]	; Negate Y-speed if it touches a side
   181 00000110 EBCC                    .9:	jmp .14
   182                                  
   183                                  .3:
   184 00000112 3CDF                    	cmp al,0xdf		; Touching paddle
   185 00000114 751B                    	jne .4
   186 00000116 29FB                    	sub bx,di		; Subtract paddle position
   187 00000118 83EB04                  	sub bx,byte 4
   188 0000011B B106                    	mov cl,6		; Multiply by 64
   189 0000011D D3E3                    	shl bx,cl
   190 0000011F 895E0A                  	mov [bp+ball_xs],bx	; New X speed for ball
   191 00000122 C7460880FF              	mov word [bp+ball_ys],0xff80	; Update Y speed for ball
   192 00000127 B9970A                  	mov cx,2711		; 1193180 / 440
   193 0000012A E86B00                  	call speaker		; Generate sound
   194 0000012D 5B                      	pop bx
   195 0000012E 58                      	pop ax
   196 0000012F EBAD                    	jmp .14
   197                                  
   198                                  .4:
   199 00000131 3CDB                    	cmp al,0xdb		; Touching brick
   200 00000133 7524                    	jne .5
   201 00000135 B94B05                  	mov cx,1355		; 1193180 / 880
   202 00000138 E85D00                  	call speaker		; Generate sound
   203 0000013B F6C302                  	test bl,2		; Aligned with brick?
   204 0000013E 7502                    	jne .10			; Yes, jump
   205 00000140 4B                      	dec bx			; Align
   206 00000141 4B                      	dec bx
   207 00000142 31C0                    .10:	xor ax,ax		; Erase brick
   208 00000144 8907                    	mov [bx],ax
   209 00000146 894702                  	mov [bx+2],ax
   210 00000149 FF4600                  	inc word [bp+score]	; Increase score
   211 0000014C F75E08                  	neg word [bp+ball_ys]	; Negate Y speed (rebound)
   212 0000014F 5B                      	pop bx
   213 00000150 58                      	pop ax
   214 00000151 FF4E04                  	dec word [bp+bricks]	; One brick less on screen
   215 00000154 7588                    	jne .14			; Fully completed? No, jump.
   216 00000156 E9BEFE                  	jmp another_level	; Start another level
   217                                  
   218                                  .5:
   219 00000159 5B                      	pop bx
   220 0000015A 58                      	pop ax
   221                                  .6:
   222 0000015B 895E0E                  	mov [bp+ball_x],bx		; Update ball position
   223 0000015E 89460C                  	mov [bp+ball_y],ax
   224 00000161 80FC19                  	cmp ah,0x19		; Ball exited through bottom?
   225 00000164 7403                    	je ball_lost		; Yes, jump
   226 00000166 E903FF                  	jmp game_loop		; No, repeat game loop
   227                                  
   228                                  	;
   229                                  	; Ball lost
   230                                  	; 
   231                                  ball_lost:
   232 00000169 B95E2A                  	mov cx,10846		; 1193180 / 110
   233 0000016C E82900                  	call speaker		; Generate sound
   234                                  
   235 0000016F C7040000                	mov word [si],0		; Erase ball
   236 00000173 FE4E02                  	dec byte [bp+balls]	; One ball less
   237 00000176 7803                    	js .1			; All finished? Yes, jump
   238 00000178 E9DAFE                  	jmp another_ball	; Start another ball
   239                                  
   240 0000017B E81300                  .1:	call wait_frame.2	; Turn off sound
   241 0000017E CD20                    	int 0x20		; Exit to DOS / bootOS
   242                                  
   243                                  wait_frame:
   244                                  .0:
   245 00000180 B400                    	mov ah,0x00		; Read ticks
   246 00000182 CD1A                    	int 0x1a		; Call BIOS
   247 00000184 3B5610                  	cmp dx,[bp+old_time]	; Wait for change
   248 00000187 74F7                    	je .0
   249 00000189 895610                  	mov [bp+old_time],dx
   250                                  
   251 0000018C FE4E06                  	dec byte [bp+beep]		; Decrease time to turn off beep
   252 0000018F 7506                    	jne .1
   253                                  .2:
   254 00000191 E461                    	in al,0x61
   255 00000193 24FC                    	and al,0xfc		; Turn off
   256 00000195 E661                    	out 0x61,al
   257                                  .1:
   258                                  
   259 00000197 C3                      	ret
   260                                  
   261                                  	;
   262                                  	; Generate sound on PC speaker
   263                                  	;
   264                                  speaker:
   265 00000198 B0B6                    	mov al,0xb6		; Setup timer 2
   266 0000019A E643                    	out 0x43,al
   267 0000019C 88C8                    	mov al,cl		; Low byte of timer count
   268 0000019E E642                    	out 0x42,al
   269 000001A0 88E8                    	mov al,ch		; High byte of timer count
   270 000001A2 E642                    	out 0x42,al
   271 000001A4 E461                    	in al,0x61
   272 000001A6 0C03                    	or al,0x03		; Connect PC speaker to timer 2
   273 000001A8 E661                    	out 0x61,al
   274 000001AA C6460603                	mov byte [bp+beep],3	; Duration
   275 000001AE C3                      	ret
   276                                  
   277                                  	;
   278                                  	; Locate ball on screen
   279                                  	;
   280                                  locate_ball:
   281 000001AF B0A0                    	mov al,0xa0
   282 000001B1 F6E4                    	mul ah			; AH = Y coordinate (row)
   283 000001B3 88FB                    	mov bl,bh		; BH = X coordinate (column)
   284 000001B5 B700                    	mov bh,0
   285 000001B7 D1E3                    	shl bx,1
   286 000001B9 01C3                    	add bx,ax
   287 000001BB C3                      	ret
   288                                  
   289                                  	;
   290                                  	; Update score indicator (from bootRogue)
   291                                  	;
   292                                  update_score:
   293 000001BC BB980F                  	mov bx,0x0f98		; Point to bottom right corner
   294 000001BF 8B4600                  	mov ax,[bp+score]
   295 000001C2 E80300                  	call .1
   296 000001C5 8A4602                  	mov al,[bp+balls]
   297                                  .1:
   298 000001C8 31C9                    	xor cx,cx              ; CX = Quotient
   299 000001CA 41                      .2:	inc cx
   300 000001CB 83E80A                  	sub ax,10              ; Division by subtraction
   301 000001CE 73FA                    	jnc .2
   302 000001D0 053A0A                  	add ax,0x0a3a          ; Convert remainder to ASCII digit + color
   303 000001D3 E80400                  	call .3                ; Put on screen
   304 000001D6 91                      	xchg ax,cx
   305 000001D7 48                      	dec ax                 ; Quotient is zero?
   306 000001D8 75EE                    	jnz .1                 ; No, jump to show more digits.
   307                                  
   308 000001DA 8907                    .3:	mov [bx],ax
   309 000001DC 4B                      	dec bx
   310 000001DD 4B                      	dec bx
   311 000001DE C3                      	ret
   312                                  
   313                                      %ifdef com_file
   314                                      %else
   315 000001DF 4F<rept>                	times 510-($-$$) db 0x4f
   316 000001FE 55AA                    	db 0x55,0xaa           ; Make it a bootable sector
   317                                      %endif
